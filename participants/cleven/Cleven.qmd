---
title: "Laura Cleven: Effect of Physical (In-)Activity on Metabolic Syndrome"
author: "Reinhold Kliegl"
date: "2022-09-17 (last revised: `r format(Sys.time())`)"
format: 
  html:
    embed-resources: true
    toc: true
    toc-depth: 2
    number-sections: true
    fig-width: 8
    fig-height: 6
editor_options: 
  chunk_output_type: console
---

# Background

"Von einem metabolischen Syndrom spricht man, wenn bestimmte Erkrankungen bzw. Symptome gemeinsam auftreten. Dazu zählen in erster Linie Übergewicht, Bluthochdruck sowie Zucker- und Fettstoffwechselstörungen. Faktoren wie körperliche Inaktivität, Stress, Rauchen und Alkohol spielen bei der Entstehung mit."

Welchen Einfluss hat körperlicher (In-)Aktivität auf die Entstehung (von Faktoren: Bluthochdruck, Diabetes, Bauchumfang nach WHO, Erhöhte Triglyceride, niedrige HDL Werte) des metabolischen Syndroms?

# Preprocessing

## RK style guide

+ Random factors should be factors, not integers!
+ Factors capitalized, continuous variables in lower case
+ `Subj` instead of `ID`; prefix subject and item numbers with `S` and `I` 
+ Short variable names and factor levels, but respect tradeoff with mmemonic value
+ Labels should be of equal length
+ Hint: Leave out vowels in names and labels
+ See Jenny Bryan's [Naming Things](https://docplayer.net/55248970-Naming-things-prepared-by-jenny-bryan-for-reproducible-science-workshop.html)

## Packages

```{r}
library(easystats)
library(tidyverse)
library(haven)
library(labelled)
library(lme4)
library(summarytools)

# respecting color vision deficiency
cbPalette <- c( "#0072B2", "#D55E00", "#009E73", "#CC79A7",
                "#F0E442", "#56B4E9", "#999999", "#E69F00")
```

## Read and transform data

Filter: Two measures and free of all outcomes at beginning

+ 6:11 - Alter
+ 33:38 - Diagn_Bauch
+ 65:70 - Diagn_Bluthochdruck
+ 97:102 - Diagn_HDL
+ 129:134 - Diagn_Triglycerin
+ 161:166 - Diagn_Diabetes
+ 193:198 - Summe Risikofaktoren
+ 199:204 - Diagn_metSyndrom
+ 236:241 - SportOGym
+ 242:247 - HA_Minuten
+ 248:253 - Minuten_GesamtSPORT
+ 254:259 - METh_GesamtSport
+ 260:265 - BMI
+ 266:271 - T(aille)?
- 272:277 - Gewicht
- 280:285 - Größe
- 286:291 - Bauch
- 292:315 - Blutdruck measures
- 316:321 - HDL
- 322:327 - Tryglyc
- 339:344 - Gluc

```{r}
data <- 
   read_sav("CLEVEN.sav") |> 
   remove_labels() |> 
   select(Subj=2, Sex=3, SES=19, ageSE=30, yearSE=5, 6:11, 33:38, 65:70, 97:102, 129:134, 161:166, 193:198, 199:204, 248:253, 260:265, 272:277, 280:285, 286:291, 316:321, 322:327, 339:344 ) |> 
   mutate( Subj = paste0("S", str_pad(as.character(Subj), width = 5, side = "left", pad = "0")),
           Sex = factor(Sex, levels=0:1, labels=c("female", "male")),
           SES = factor(SES)
           ) |> 
   relocate(Subj:SES)

colnames(data) <-  gsub("Alter", "age", colnames(data))
colnames(data) <-  gsub("Diagn_", "D", colnames(data))
colnames(data) <-  gsub("Bauch", "Bch", colnames(data))
colnames(data) <-  gsub("Bluthochdruck", "Bhd", colnames(data))
colnames(data) <-  gsub("Triglyc", "Tgl", colnames(data))
colnames(data) <-  gsub("Diabetes", "Dbt", colnames(data))
colnames(data) <-  gsub("risikofaktoren_summe", "rfsum", colnames(data))
colnames(data) <-  gsub("metSyndrom", "mS", colnames(data))
colnames(data) <-  gsub("Minuten_GesamtSPORT", "sport", colnames(data))
stview(dfSummary(data))
```

**Questions/Issues**

+ Is there a composite variable "metabolic syndrome" (e.g., latent contructs based on indicators)
+ There are probably better alternatives to (G)LMM, e.g., growth curve models the different lags of effects across time.
+  If `rfsum`  is used as dependent variable, a cumulative link mixed model should probably be used. (Is DmS == 1, if rfsum >= 3?)

## Subset selection / wide to long format

```{r}
dat <- 
  data |> 
  select(1:65) |> 
  pivot_longer(6:65, names_to=c("Variable", "year"), names_sep="_",
               names_transform=list(Variable =as.factor, year=as.integer),
               values_to="value", values_drop_na=TRUE) |> 
  mutate(year = ifelse(year>90, year+1900, year+2000)) 
  
  
stview(dfSummary(dat))
```

# Varying covariate: `year`

## Construct dataframe

+ Criterion: `DmS` in year
+ Constant covariates: `Sex`, `ageSE` (`a1,` `a2`) for `Subj`
+ Varying covariate: `year` (`y1`, `y2`) for `Subj`

```{r}
dat_DmS_1 <- 
  data |> 
  select(1:4, 48:53) |> 
  pivot_longer(5:10, names_prefix="DmS_", names_to= "year", 
               names_transform=list(year=as.integer),
               values_to="DmS", values_drop_na=TRUE) |> 
  mutate(year = ifelse(year>90, year+1900, year+2000),
         y1 = year - 2006.5,
         y2 = y1*y1,
         a1 = ageSE - 55,
         a2 = a1*a1) |> 
  relocate(y1:a2, .after=year)
  
  
stview(dfSummary(dat_DmS_1))
with(dat_DmS_1, table(year, DmS, Sex))
```

## Plot: Year (within-subject)

```{r}
dat_DmS_1 |> 
  group_by(year, Sex) |> 
  summarize(N=n(), pDmS = mean(DmS)) |> 
  ggplot(aes(x=year, y=pDmS, group=fct_rev(Sex), color=fct_rev(Sex))) +
  geom_point() + 
  geom_smooth(method="lm", formula=y~poly(x,2), se=FALSE) +
  scale_x_continuous("Year", breaks=seq(1992,2022,5)) +
  scale_y_continuous("Prob(Diagnosis of metabolic syndrome)") +
  scale_color_manual("Sex", values=cbPalette) +
  theme_bw() + theme(legend.position = "top") +
  coord_cartesian(xlim=c(1992,2022), ylim=c(0,.5))
```

## Plot: Age at entry to study (between-subject)

```{r}
dat_DmS_1 |> 
  ggplot(aes(x=ageSE, y=DmS, group=fct_rev(Sex), color=fct_rev(Sex))) +
  geom_smooth(method="lm", formula=y~poly(x,2), se=FALSE) +
  scale_x_continuous("Age at study entry", breaks=seq(30,80, 5)) +
  scale_y_continuous("Prob(Diagnosis of metabolic syndrome)") +
  scale_color_manual("Sex", values=cbPalette) +
  theme_bw() + theme(legend.position = "top") +
  coord_cartesian(xlim=c(30,80), ylim=c(0,.5))
```

## Generalized linear mixed models

### _A priori_ LMM

+ `Sex` is between-subject
+ `age` is between-subject
+ `year` is within-subject

```{r}
contrasts(dat_DmS_1$Sex) <- contr.sum(2)

m1 <- glmer(DmS ~ 1 + Sex*(y1 + y2) + a1  + a2 + (1 | Subj), data=dat_DmS_1,
            family = binomial(link="logit"),
            control=glmerControl(calc.derivs=FALSE))

print(summary(m1),corr=FALSE)

```

```{r}
dat_DmS_1 |> 
  ggplot(aes(x=ageSE, y=DmS, group=1)) +
  geom_smooth(method="lm", formula=y~poly(x,2), se=FALSE) +
  scale_x_continuous("Age at study entry", breaks=seq(30,80, 5)) +
  scale_y_continuous("Prob(Diagnosis of metabolic syndrome)") +
  theme_bw() + theme(legend.position = "top") +
  coord_cartesian(xlim=c(30,80), ylim=c(0,.5))
```

### _Post-hoc_ LMM

```{r}
contrasts(dat_DmS_1$Sex) <- contr.sum(2)

m1b <- glmer(DmS ~ 1 + Sex/(y1 + y2) + a1  + a2 + (1 | Subj), data=dat_DmS_1,
            family = binomial(link="logit"),
            control=glmerControl(calc.derivs=FALSE))

print(summary(m1b),corr=FALSE)
```

# Varying covariates: `year` and `age`

## Construct dataframe

+ Criterion: `DmS` in year
+ Constant covariates: `Sex` for `Subj`
+ Varying covariate: `y1`, `y2`, `a1` , `a2` for `Subj`

```{r}
dat_age <- 
  dat |> filter(Variable=="age") |> 
  select(Subj, year, age=value)

dat_DmS_2 <- 
  dat_DmS_1  |> 
  select(-a1, -a2) |> 
  left_join(dat_age, by=c("Subj", "year") ) |> 
  mutate(a1 = age - 55,
         a2 = a1*a1) |> 
  relocate(age:a2, .after=y2)
  
  
stview(dfSummary(dat_DmS_2))
```

## Plots: Age effect at diagnosis  (within-subject)

```{r}
dat_DmS_2 |> 
  ggplot(aes(x=age, y=DmS, group=fct_rev(Sex), color=fct_rev(Sex))) +
  geom_smooth(method="lm", formula=y~poly(x,2), se=FALSE) +
  scale_x_continuous("Age at diagnosis of metabolic syndrome", breaks=seq(30,80, 5)) +
  scale_y_continuous("Prob(Diagnosis of metabolic Syndome)") +
  scale_color_manual("Sex", values=cbPalette) +
  theme_bw() + theme(legend.position = "top") +
  coord_cartesian(xlim=c(30,80), ylim=c(0,.5))
```

```{r}
dat_DmS_2 |> 
  ggplot(aes(x=age, y=DmS, group=1)) +
  geom_smooth(method="lm", formula=y~poly(x,2), se=FALSE) +
  scale_x_continuous("Age at diagnosis of metabolic syndrome", breaks=seq(30,80, 5)) +
  scale_y_continuous("Prob(Diagnosis of metabolic Syndome)") +
  theme_bw() + theme(legend.position = "top") +
  coord_cartesian(xlim=c(30,80), ylim=c(0,.5))
```

## Generalized LMM

+ `Sex` is between-subject
+ `age` is within-subject
+ `year` is within-subject

```{r}
contrasts(dat_DmS_2$Sex) <- contr.sum(2)

m2 <- glmer(DmS ~ 1 + Sex*(y1 + y2) + a1  + a2 +  (1 | Subj), data=dat_DmS_2,
            family = binomial(link="logit"),
            control=glmerControl(calc.derivs=FALSE))

print(summary(m2),corr=FALSE)

```

# Varying covariates: `year`, `age`, `rfsum`, `sport`

## Construct dataframe

+ Criterion: `DmS` in year
+ Constant covariates: `Sex` for `Subj`
+ Varying covariate: `y1`, `y2`, `a1` , `rfsum`, `sport` for `Subj`
+ 5.5 missing values for sport are replaced by median (81 minutes) (by subj)
+ sport_l = log(sport+1), that is increase by 1 minute and take log
+ reference value for risk factor and sport_l is 0.
+ Question: Is DmS == 1, if rfsum >=3? and 0 else? 


```{r}
dat_rf_sport <- 
  dat |> filter(Variable=="rfsum" | Variable =="sport") |> 
  select(Subj, year, Variable, value) |> 
  pivot_wider(names_from="Variable", values_from = "value")

dat_rf_sport |> 
  ggplot(aes(x=log(sport +1))) +
  geom_histogram() +  # geom_density
  theme_bw()

dat_rf_sport |> ggplot(aes(x=rfsum)) + geom_histogram() + theme_bw()

dat_DmS_3 <- 
  dat_DmS_2  |> 
  select(-a2) |> 
  left_join(dat_rf_sport, by=c("Subj", "year") ) |> 
  mutate(sport = ifelse(is.na(sport), 81, sport),    
         sport_l = log(sport+1)) |> 
  relocate(rfsum:sport_l, .after=a1)
  
stview(dfSummary(dat_DmS_3))
```

## Plot: Risk factor and time spent at sports at diagnosis  (within-subject)

```{r}
tbl_rf <- 
  dat_DmS_3 |> 
  group_by(rfsum) |> 
  summarise(N=n(), pDmS=sum(DmS)/N)
tbl_rf
```

This looks like the `DmS` is determined by the number of risk factors (i.e., 
if  `rfsum` >= 3, `DmS` == 1). We ignore it for present purposes and focus on `sport_l`. 

```{r}
dat_DmS_3 |> 
  ggplot(aes(x=sport_l, y=DmS, group=Sex, color=Sex)) +
  geom_smooth(method="lm", formula=y~poly(x,1), se=FALSE) +
  scale_x_continuous("Log(minutes) spent at sport", breaks=1:7) +
  scale_y_continuous("Prob(Diagnosis of metabolic Syndome)") +
  theme_bw() + theme(legend.position = "top") +
  coord_cartesian(xlim=c(0, 7), ylim=c(0,.5))
```

## Generalized LMM

+ `Sex` is between-subject
+ `age` is within-subject
+ `year` is within-subject

```{r}
contrasts(dat_DmS_3$Sex) <- contr.sum(2)

m3 <- glmer(DmS ~ 1 + Sex*(y1 + y2 + sport_l) + a1  + sport_l +  (1 | Subj), data=dat_DmS_3,
            family = binomial(link="logit"),
            control=glmerControl(calc.derivs=FALSE))

print(summary(m3),corr=FALSE)
```

No sport vs. sport?

```{r}
dat_DmS_3$sport2 <-  ifelse(dat_DmS_3$sport_l == 0, 0, 1)

m4 <- glmer(DmS ~ 1 + Sex*(y1 + y2 + sport2) + a1  +  (1 | Subj), data=dat_DmS_3,
            family = binomial(link="logit"),
            control=glmerControl(calc.derivs=FALSE))

print(summary(m4),corr=FALSE)

m4b <- glmer(DmS ~ 1 + Sex + sport2 + a1 +  (1 | Subj), data=dat_DmS_3,
            family = binomial(link="logit"),
            control=glmerControl(calc.derivs=FALSE))

print(summary(m4b),corr=FALSE)
```


# Varying covariates: `year`, `age`, five factors

## Construct dataframe

+ Criterion: `DmS` in year
+ Constant covariates: `Sex` for `Subj`
+ Varying covariate: `y1`, `y2`, `a1` , `DBch`, `DDbt`, `DTgl`, `DHDL`
, `DBhd`
+ Missing values assigned to 0: 1 obs for `DTgl`, 118 obs (4.8%) for `DBch` 
+ They are all numeric 0/1 indicators

```{r}
dat_factors <- 
  dat |> filter(Variable %in% c("DBch", "DBhd", "DDbt", "DHDL", "DTgl")) |> 
  select(Subj, year, Variable, value) |> 
  pivot_wider(names_from="Variable", values_from = "value")

dat_DmS_4 <- 
  dat_DmS_2  |> 
  select(-a2) |> 
  left_join(dat_factors, by=c("Subj", "year") ) |> 
  mutate(DTgl = ifelse(is.na(DTgl), 0, DTgl),    
         DBch = ifelse(is.na(DBch), 0, DBch)) |> 
  relocate(DBhd:DBch, .after=a1)
  
stview(dfSummary(dat_DmS_4))
```

## Generalized LMM

+ `Sex` is between-subject
+ `age` is within-subject
+ `year` is within-subject
+ `DBch`, `DBhd`, `DDbt`, `DHDL`, `DTgl` are within-subject

```{r}
contrasts(dat_DmS_4$Sex) <- contr.sum(2)

m5 <- glmer(DmS ~ 1 + Sex*(y1 + y2) + a1 +   
                      DBch + DBhd + DHDL + #DDbt + #DTgl +
                 (1 | Subj), data=dat_DmS_4,
            family = binomial(link="logit"),
            control=glmerControl(calc.derivs=FALSE))

print(summary(m5),corr=FALSE)
```

**Results**

+ `DTgl` is problematic -- perhaps because not assessed initially
+  Any three of the other four generate huge effects
+  Sex main effect and interaction with year are no longer significant

# Summary

Of course, the same script could be adjusted to use the measures instead of the diagnoses as predictors. 


# Appendix

```{r}
sessionInfo()
```
