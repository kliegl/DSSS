---
title: "Tanja Eberhardt: Fitnessbarometer Baden-Württemberg"
author: "Reinhold Kliegl"
date: "2022-09-17 (last revised: `r format(Sys.time())`)"
format: 
  html:
    embed-resources: true
    toc: true
    toc-depth: 2
    number-sections: true
    fig-width: 8
    fig-height: 6
editor_options: 
  chunk_output_type: console
---

# Background
+ Projekt in Zusammenarbeit mit der Kinderturnstiftung Baden-Württemberg und der Odwin gGmbH
+ Präsentation der aktuellen Ergebnisse zur körperlichen Leistungsfähigkeit von 28,427 Kindern in BaWü
+ Wie hat sich die motorische Leistungsfähigkeit/ einzelne Dimensionen/ einzelne TA in den letzten 10 Jahren (2012-2021) entwickelt? 

# Preprocessing

## RK style guide

+ Random factors should be factors, not integers!
+ Factors capitalized, continuous variables in lower case
+ `Subj` instead of `ID`; prefix subject and item numbers with `S` and `I` 
+ Short variable names and factor levels, but respect tradeoff with mmemonic value
+ Labels should be of equal length
+ Hint: Leave out vowels in names and labels
+ See Jenny Bryan's [Naming Things](https://docplayer.net/55248970-Naming-things-prepared-by-jenny-bryan-for-reproducible-science-workshop.html)

## Packages

```{r}
library(easystats)
library(tidyverse)
library(readxl)
library(lme4)
library(hypr)
library(summarytools)

# respecting color vision deficiency
cbPalette <- c( "#0072B2", "#D55E00", "#009E73", "#CC79A7",
                "#F0E442", "#56B4E9", "#999999", "#E69F00")
```

## Read and transform data

```{r}
dat_w <- 
   read_excel("EBERHARDT.xlsx") |> 
   select(Child=20,  Source=17, Event=18, Test=19, cohort=1,  District=3, LK=21, PLZ,
          age=4, Sex=5, BMI=50, height=6,  mass=7, bmi=8, 
          s20_r=9, bbw=10, lsj=11, sar=12, pu=13, su=14, slj=15, run=16) |> 
   mutate(Child=factor(paste0("C", Child)),
          Source=factor(Source),
          Event=factor(paste0("E", str_pad(Event, width = 5, side = "left", pad = "0"))),
          Event=na_if(Event, "ENA"),
          Test=factor(paste0("T", str_pad(as.character(Test), width = 5, side = "left", pad = "0"))),
          District=(fct_recode(factor(District), "FR"="1", "KA"="2", "S"="3", "TÜ"="4")),
          LK=factor(paste0("LK", LK)),
          PLZ=factor(paste0("PLZ", PLZ)),
          s20_r = 20/s20_r ) |> 
   filter(between(age, 6, 10))  

stview(dfSummary(dat_w))
```

**Questions**

+ Longitudinal children?
+ Filter for plausible values (e.g., 0 for pu, su, bbw)

# Transformations

## Check tests

```{r}
datx <- dat_w |> filter(!is.na(s20_r))
MASS::boxcox(s20_r ~ 1 + age + Sex + bmi, data=datx)

datx <- dat_w |> filter(!is.na(bbw))
MASS::boxcox(bbw+1 ~ 1 + age + Sex + bmi, data=datx)

datx <- dat_w |> filter(!is.na(lsj))
MASS::boxcox(lsj ~ 1 + age + Sex + bmi, data=datx)

datx <- dat_w |> filter(!is.na(pu))
MASS::boxcox(pu+1 ~ 1 + age + Sex + bmi, data=datx)

datx <- dat_w |> filter(!is.na(su))
MASS::boxcox(su+1 ~ 1 + age + Sex + bmi, data=datx)

datx <- dat_w |> filter(!is.na(slj))
MASS::boxcox(slj ~ 1 + age + Sex + bmi, data=datx)

datx <- dat_w |> filter(!is.na(run))
MASS::boxcox(run ~ 1 + age + Sex + bmi, data=datx)
```

## From wide to long format 

```{r}
dat <- dat_w %>% 
  select(cohort, District, LK, PLZ, Event, Child, Sex,  age,  
                bmi, s20_r, bbw, lsj, sar, pu, su, slj, run) |> 
  pivot_longer(s20_r:run, names_to = "Test", values_to = "score", values_drop_na = TRUE) |> 
  mutate(Sex = factor(Sex),
         Test = factor(Test, 
                       levels=c("run", "s20_r", "bbw", "lsj", "slj", "pu", "su", "sar"))) |> 
  group_by(Sex, Test) %>%
  mutate(zScoreA  = scale(score),
         zBound30 = ifelse(abs(zScoreA) < 3.0, TRUE, FALSE)) %>% 
  filter(zBound30) %>% 
  group_by(Test) %>%
  mutate(zScore = as.numeric(scale(score))) %>% 
  dplyr::select(cohort:score, zScore) %>% 
  droplevels %>% 
  ungroup

stview(dfSummary(dat))
```

# Figure 
# Figure 1:  age x Sex x Test

Read whatever sample you need:

+ YRK, keyage, and OTK children
+ only keyage children  <- closest to Teich et al. (2022)
+ only keyage children with bmi 

```{r fig.width=20, fig.height=14, unit="cm"}
table <- 
  dat |>  
  mutate(Age = round(age)) |> 
  group_by(Age, Sex, Test) %>% 
  summarise(N=n(), zScoreM=mean(zScore), SD=sd(zScore), 
            CI=1.96*SD/sqrt(N), .groups="drop") |> 
  rename(age=Age, zScore=zScoreM)

fig1 <- 
  dat |> 
  ggplot(aes(x=age, y=zScore, group=Sex, shape=Sex)) +  
  facet_wrap(~ Test, nrow=2) +
  geom_smooth(method="lm", se=TRUE,  colour="black", size=.75) +
  geom_point(data=table, fill="white") + 
  scale_shape_manual(values=c(16,21)) +
  scale_x_continuous("Age [years]", breaks=seq(6,10,1)) +
  scale_y_continuous("z-score [± SD]") + 
  geom_hline(aes(yintercept=0)) + 
  coord_cartesian(ylim=c(-0.75,+0.75)) +
  theme_bw(base_size=16) +  theme(legend.justification=c(0,1), legend.position=c(0, 1), 
                      legend.background=element_rect(fill="white", color="black"),
                      legend.title=element_blank(), legend.direction="horizontal")
fig1

ggsave("figures/btpk22_fig1_keyage.jpg", width=20, height=14, unit="cm")
```

# Linear mixed models

## Contrasts and trends

+ `contr.sum` uses ‘sum to zero contrasts’, that is returns the difference of factor level means to Grand Mean (except for the last level); Grand Mean is mean of condition means. 
+ Not much evidence for more than linear trends
+ `contr.sdif` tests neighboring levels

```{r}
contrasts(dat$Sex) <- contr.sum(2)
contrasts(dat$Test) <- MASS::contr.sdif(8)
```

## _A priori_ LMM

```{r}
dat$Cohort <-  factor(dat$cohort)
dat$a1 <- dat$age - 8
dat$a2 <- dat$a1*dat$a1
m1 <- lmer(zScore ~ 1 + Test/(Sex*(a1+a2)) + (1 | Child) + (1 | Cohort), 
           data=dat, REML=TRUE, control=lmerControl(calc.derivs=FALSE))
print(summary(m1), corr=FALSE)
```

# Appendix

```{r}
sessionInfo()
```
