---
title: "Leon Klos: Effects of Enviroment Perception on Active Transport"
author: "Reinhold Kliegl"
date: "2022-09-017 (last revised: `r format(Sys.time())`)"
format: 
  html:
    embed-resources: true
    toc: true
    toc-depth: 2
    number-sections: true
    fig-width: 8
    fig-height: 6
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(arrow)
library(tidyverse)
library(easystats)
library(summarytools)
library(lme4)
```

# Background

## Introduction

Active transport can contribute to health of adolescents by increasing low to moderate intensity physical activity levels. Few studies have addressed active transport during leisure and previous works suggest that perceptions of the environment (e. g. traffic safety, recreational facilities) differ between urban and rural areas. No studies have so far been conducted in Germany on active transport behavior during leisure.

## Research questions

1.	Is there a relationship between different attributes of the perceived environment and walking and cycling for leisure in adolescents? 
2.	Is there a relationship between urbanicity and walking and cycling for leisure? 
3.	Do the perceptions of environment attributes differ between urban and rural areas?
4.	Does the relationship between perceived environment and walking and cycling for leisure differ between levels of urbanicity?


## Issues

+	Use wave 3 and wave 4 data: larger sample size but not all variables available for wave 4.
+	Perceived environment: Work with single items/categories (what about items without categories?) or calculate factors? 
+	Separate analyses for walking and cycling (maybe in a next step: Is there a way to combine these outcomes – e.g., by creating groups: high walking & low cycling vs. low walking vs. high cycling etc.)


## Variables in file (subset used in example)

+ Subj:	Subject id, random factor
+ iafussT3
+ iaradT3
+ iafussT
+ iaradT4

# Preprocessing

## RK style guide

+ Random factors should be factors, not integers!
+ Factors capitalized, continuous variables in lower case
+ `Subj` instead of `ID`; prefix subject and item numbers with `S` and `I` 
+ Short variable names and factor levels, but respect tradeoff with mmemonic value
+ Labels should be of equal length
+ Hint: Leave out vowels in names and labels
+ See Jenny Bryan's [Naming Things](https://docplayer.net/55248970-Naming-things-prepared-by-jenny-bryan-for-reproducible-science-workshop.html)

## Packages

```{r}
library(easystats)
library(tidyverse)
library(lme4)
library(hypr)
library(summarytools)

# respecting color vision deficiency
cbPalette <- c( "#0072B2", "#D55E00", "#009E73", "#CC79A7",
                "#F0E442", "#56B4E9", "#999999", "#E69F00")
```

## Read and transform data

+ Assumption: each row is one person
+ Bew43T3: excluded MoMo_T3 In meiner Wohnumgebung fahren Autos
+ atp: active transport; mean of 11 items (Bew37T3 to Bew48T3; each coded 1 to 4)
+ wuSp: sum of 5 binary items (WUsport1_T3 to WUsport5_T3; 1="ja", 2="nein"; 10-sum = n of "ja")
+ SES: assign missing to medium

```{r}
library(labelled)

datBW <- 
    readRDS("KLOS.rds") |> 
    remove_labels() |> 
    select(starts_with("Bew"), -Bew43T3) |> 
    rowid_to_column(var="Subj") |> 
    mutate(Subj = factor(paste0("S", str_pad(Subj, width = 4, side = "left", pad = "0")))) |> 
    rowwise() |> 
    mutate(atp = mean(c_across(starts_with("Bew")), na.rm=TRUE)) 

datWU <- 
  readRDS("KLOS.rds") |> 
  remove_labels() |> 
  select(starts_with("WUsport")) |> 
  rowid_to_column(var="Subj") |> 
  mutate(Subj = factor(paste0("S", str_pad(Subj, width = 4, side = "left", pad = "0")))) |> 
  rowwise() |> 
  mutate( wuSp = 10-sum(c_across(starts_with("WUsport")))) 

dat_w <- 
  readRDS("KLOS.rds") |> 
  remove_labels() |> 
  select(-Bew43T3) |> 
  rowid_to_column(var="Subj") |> 
  mutate(Subj = factor(paste0("S", str_pad(Subj, width = 4, side = "left", pad = "0"))),
         SDEses_T3 = ifelse(is.na(SDEses_T3), 2, SDEses_T3),
         SES = factor(SDEses_T3, labels=c("low", "medium", "high")),
         ses = ifelse(is.na(SDEses_score_T3), 14, SDEses_score_T3),
         ses_c = ses - 14,
         wuOrt = ifelse(is.na(WUort1_jj_T3), 2004, WUort1_jj_T3),
         wuOrt_c = wuOrt-2004) |> 
  rowwise() |> 
  mutate(atp = mean(c_across(starts_with("Bew")), na.rm=TRUE),
         atp = ifelse(is.na(atp), 2.9, atp),
         atp_c = atp - 2.5,
         wuSp =10 - sum(c_across(starts_with("WUsport")))) |> 
  select(Subj,  SES, ses, ses_c, wuSp, wuOrt, wuOrt_c,  atp, atp_c,
         fuss_3=iafussT3, rad_3=iaradT3)

#stview(dfSummary(dat_w))

dat <- 
  dat_w |> 
  pivot_longer(10:11, names_to=c("Type", "Time"), names_sep="_", values_to="rating") |> 
  mutate(Type=fct_recode(Type, "foot"='fuss', "bicycle"='rad')) |> 
  filter(!is.na(rating))

MASS::boxcox(rating ~ atp+Type, data=dat) # looks good

#stview(dfSummary(dat))
```

**Issues**

+ Missing values for `wuSp`
+ Replacement of missing values for other covariates
+ Only two dependent measures so far, integrate T4!

# Descriptives (smooths)

## SES

```{r}
dat |> 
  ggplot(aes(x=ses, y=rating, group=Type, color=Type)) +
#  geom_smooth() +
  geom_smooth(method="lm") +
  scale_colour_manual("Type", values=cbPalette) +
  scale_x_continuous("Socioeconomic status") +
  scale_y_continuous("Rating") +
  theme_bw()  +
  coord_cartesian(xlim=c(1, 25), ylim=c(1, 6))
```

## Move to location

```{r}
dat |> 
  ggplot(aes(x=wuOrt, y=rating, group=Type, color=Type)) +
#  geom_smooth() +
  geom_smooth(method="lm") +
  scale_colour_manual("Type", values=cbPalette) +
  scale_x_continuous("Move to location") +
  scale_y_continuous("Rating") +
  theme_bw()  +
  coord_cartesian(xlim=c(1985, 2017), ylim=c(1, 6))
```

## Active transport

```{r}
dat |> 
  ggplot(aes(x=atp, y=rating, group=Type, color=Type)) +
  geom_smooth() +
#  geom_smooth(method="lm") +
  scale_colour_manual("Type", values=cbPalette) +
  scale_x_continuous("Active transport") +
  scale_y_continuous("Rating") +
  theme_bw()  +
  coord_cartesian(xlim=c(1, 4), ylim=c(1, 6))
```

# Linear mixed models

## Contrasts and trends

+ `contr.sum` uses ‘sum to zero contrasts’, that is returns the difference of factor level means to Grand Mean (except for the last level); Grand Mean is mean of condition means. 
+ Not much evidence for more than linear trends


```{r}
contrasts(dat$Type) <- contr.sum(2)
contrasts(dat$Type)
```

## _A priori_ LMM

```{r}
m_voi1 <- lmer(rating ~ 1 + Type*(ses_c+wuOrt_c + atp_c) + (1 | Subj), data=dat, REML=FALSE,
              control=lmerControl(calc.derivs=FALSE))
print(summary(m_voi1), corr=FALSE)
```

## _Post-hoc_ LMM

```{r}
m_voi2 <- lmer(rating ~ 1 + Type/(ses_c+wuOrt_c + atp_c) + (1 | Subj), data=dat, REML=FALSE,
              control=lmerControl(calc.derivs=FALSE))
anova(m_voi1, m_voi2)

print(summary(m_voi2), corr=FALSE)
```


# Appendix

```{r}
sessionInfo()
```

