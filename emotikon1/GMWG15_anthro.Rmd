---
title: "EMOTIKON: How Body Height and Mass Moderate the Development of Physical Fitness Components"
author: "Reinhold Kliegl, Thea Fühner, Kathleen Golle, & Urs Granacher"
date: "2021-02-16 (updated: `r Sys.time()`)"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: no
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

# Longitudinal ontogenesis and anthropometry  (**Emotikon**, 2006 to 2009)

These data are from Golle et al. (2015). Physical Fitness Percentiles of German Children Aged 9–12 Years: Findings from a Longitudinal Study. _PLoS ONE, 10,_ 11 (doi:10.1371/journal.pone.0142393). 

We test `Sex`,  `age`, `height`, and `mass` effects for five physical fitness tests assessed annully from 2006 to 2009. The five tests () represent the following components: 

We compare the results with using `bmi`. 

# Setup

Variables for this re-analysis were extracted from a comprehensive data file; tests were z-transformed with mean and standard deviation of first assessment in 2006 with script `GMWG15_preproc.Rmd`.

The following variables are used.
 
1. School: 27 levels 
2. Child: 240 levels; all children were tested four times (2006 - 2009)
3. Sex: "Boys" (n=152), "Girls" (n=88)
4. age: test date - middle of month of birthdate (specific for year)
5. year: 2006 - 2009
6. height (specific for year)
7. mass (specific for year)
8. bmi (specific for year)
9. fat (specific for year, but with missing data)
10. Test: 5 levels:
    + Endurance (`Run`; cardiorespiratory):  6 minute endurance run [m]; to nearest 9m in 9x18m field
    + Coordination (`Star_r`): Star coordination run [m/s]; 9x9m field, 4 x diagonal = 50.912 m
    + Speed(`S50_r`): 50-meters sprint [m/s]
    + PowerLOW (`THJ`; muscular): tripe hop jump [cm] 
    + PowerUP (`BPT`; muscular): (1-kg medicine) ball push test [m] with one arm
11. zScore

# Setup

**To do**

+ Partial effect plots 
+ Test quadratic trend for `mass` in current LMM
+ Test quadratic trend for `height`in current LMM
+ Alternative LMM with test contrasts rather  nesting within levels of tests
+ LMM with `bmi`  in place of `height` and `mass`


```{r message = FALSE}
library(MASS)
library(gtools)
library(lme4)
library(remef)
library(tidyverse)
library(cowplot)


dat <- readRDS("data/gmwg15.rds")  %>% filter(Test != "Flexibility")
# age trends
dat$a1 <- dat$age - 11  # center at 11 years
dat$a2 <- dat$a1^2
# center
dat$height_c <- scale(dat$height, center=TRUE, scale=FALSE)
dat$mass_c <- scale(dat$mass, center=TRUE, scale=FALSE)
```

# Basic growth curves

## Figure 1: Physical Fitness

```{r message=FALSE, fig.width=7, fig.height=3.5}
t_AST <- dat %>% 
  group_by(year, Sex, Test) %>% 
  summarise(N=n(), age=mean(age), height=mean(height), mass=mean(mass), bmi=mean(bmi), fat=mean(fat),
            M=mean(zScore), SD=sd(zScore), CI=1.96*SD/sqrt(N), .groups="drop") 

fig1 <- 
  dat %>%
  ggplot(aes(x=age, y=zScore, group=Sex, shape=Sex)) +  
  facet_wrap(~Test, nrow = 1) +
  geom_smooth(method="lm", formula=y ~ poly(x,2), se=TRUE,  colour="black", size=.75) + 
  geom_point(data=t_AST, aes(x=age, y=M), fill="white", size=2) + 
  scale_shape_manual(values=c(16,21)) +
  scale_x_continuous("Age") +
  scale_y_continuous("z-score") + 
  geom_hline(yintercept=0) + theme_bw() +
  theme(legend.justification=c(.01,.99), legend.position=c(.01, .99),legend.title=element_blank()) 
fig1

ggsave("figures/Fig1_AST.pdf", width=7, height=3.5)
```

## Figure 2: Anthropometric covariates

We also include physical fitness, that is the average z-scores of the five tests.

```{r message=FALSE, fig.width=7, fig.height=3.5}
t_ASC <- dat %>% 
  dplyr::select(Child:bmi, zScore) %>% 
  group_by(Child, year, Sex) %>% 
  summarise(N=n(), age=first(age), height=first(height), mass=first(mass), 
            bmi=first(bmi), physical_fitness=mean(zScore), .groups="drop") %>% 
  pivot_longer(cols=6:9, names_to="Covariate", values_to="Score") %>% 
  group_by(year, Sex, Covariate) %>%
  summarise(age=mean(age),  M=mean(Score), SD=sd(Score), CI=1.96*SD/sqrt(N), .groups="drop") 

fig2 <- 
  dat %>%
  group_by(Child, Sex, year) %>% 
  summarize(N = n(), age = first(age), height=first(height), mass=first(mass), bmi=first(bmi), 
            physical_fitness=mean(zScore), .groups="drop") %>% 
  pivot_longer(cols=6:9, names_to="Covariate", values_to="Score") %>% 
  ggplot(aes(x=age, y=Score, group=Sex, shape=Sex)) +  
  facet_wrap(~ Covariate, nrow = 1, scales = "free_y") +
  geom_smooth(method="lm", formula=y ~ poly(x,1), se=TRUE,  colour="black", size=.75) + 
  geom_point(data=t_ASC, aes(x=age, y=M), fill="white", size=2) + 
  scale_shape_manual(values=c(16,21)) +
  scale_x_continuous("Age") +
  scale_y_continuous("Score") + 
  coord_cartesian(xlim=c(9, 13)) + theme_bw() +
  theme(legend.justification=c(.01,.99), legend.position=c(.01, .99),legend.title=element_blank()) 
fig2 

ggsave("figures/Fig2_ASC.pdf", width=7, height=3.5)
```

## LMM for growth of height and mass

### Height
```{r}
mm_hght <- lmer(height ~ 1 + Sex*(a1 + a2) + (1 + a1 | Child) + (1 + a1 + a2 || School),
                        data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))

print(summary(mm_hght), corr=FALSE)
```

### Mass
```{r}
mm_mass <- lmer(mass ~ 1 + Sex*(a1 + a2) + (1 + a1 | Child) + (1 + a1 + a2 || School),
                        data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))

print(summary(mm_mass), corr=FALSE)
```

### BMI
```{r}
mm_bmi<- lmer(bmi ~ 1 + Sex*(a1 + a2) + (1 + a1 | Child) + (1 + a1 + a2 || School),
                        data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))

print(summary(mm_bmi), corr=FALSE)
```


# Longitudinal linear mixed model - post-hoc nested with tests

## Baseline LMM

We start with the basic LMM for physical fitness without anthropometric measures (see: `emotikon_02_2020_age_sex_long.Rmd`) and then add `height` and `mass` to the model. 

```{r}
contrasts(dat$Sex) <- (-1)*MASS::contr.sdif(2)
dat$sex <- ifelse(dat$Sex == "Boys", +1/2, -1/2)

dat$Test <- droplevels(dat$Test)
contrasts(dat$Test) <- MASS::contr.sdif(5)

# simple LMM
base <- lmer(zScore ~ 1 + Test/(Sex*a1 + a2) + (1 + a1 | Child) + (1 + a1 + a2 || School),
                        data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))

print(summary(base), corr=FALSE)
```

## Adding height and mass

```{r}
# Full fixed-effect model
fe5 <- lmer(zScore ~ 1 + Test/((Sex + (a1 + a2) + height_c + mass_c)^5)  +  
                       (1 + a1 | Child) + (1 + a1 + a2 || School),
                        data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))
summary(rePCA(fe5))
VarCorr(fe5)
anova(base, fe5)

fe4 <- lmer(zScore ~ 1 + Test/((Sex + (a1 + a2) + height_c + mass_c)^4)  + 
                       (1 + a1 | Child) + (1 + a1 + a2 || School),
                        data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))

fe3 <- lmer(zScore ~ 1 + Test/((Sex + (a1 + a2) + height_c + mass_c)^3)  + 
                       (1 + a1 | Child) + (1 + a1 + a2 || School),
                        data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))

fe2 <- lmer(zScore ~ 1 + Test/((Sex + (a1 + a2) + height_c + mass_c)^2)  + 
                       (1 + a1 | Child) + (1 + a1 + a2 || School),
                        data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))

# removing sex x age interactions and interactions between age and height, mass within levels of test
fe2_1 <- lmer(zScore ~ 1 + Test/(a1 + a2 + Sex*height_c*mass_c)  + 
                       (1 + a1 | Child) + (1 + a1 + a2 || School),
                        data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))

# do we still need a1 x sex for bpt? No
fe2_2 <- lmer(zScore ~ 1 + Test/(a1 + a2 + Sex*height_c*mass_c + a1:Sex)  + 
                       (1 + a1 | Child) + (1 + a1 + a2 || School),
                        data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))
anova(fe2_1, fe2_2)

# adding height^2 No
h2 <- dat$height_c^2
fe2_3 <- lmer(zScore ~ 1 + Test/(a1 + a2 + Sex*(height_c+h2)*mass_c + a1:Sex)  + 
                       (1 + a1 | Child) + (1 + a1 + a2 || School),
                        data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))
anova(fe2_1, fe2_3)


# removing all interactions within levels of test
fe1 <- lmer(zScore ~ 1 + Test/(Sex + (a1 + a2) + height_c + mass_c)  + 
                       (1 + a1 | Child) + (1 + a1 + a2 || School),
                        data=dat, REML=FALSE, control=lmerControl(calc.derivs=FALSE))

anova(fe1, fe2_1, fe2, fe3, fe4, fe5)


# Keep fe2_1
print(summary(fe2_1), corr=FALSE)
```

**Summary**  

+ Significant for all tests: age1(+), age2(-), sex(b>g), height(+)
+ Not significant for any test:  sex x height, sex x mass (but is part of height x sex mass for bpt)
+ Exception 1:  mass(+) for bpt, else: mass(---)
+ Exception 2:  height x mass (+) for endurance, speed, powerLOW, powerUP (marginally); not significant for coordination 
+ Exception 3: sex x height x mass only significant for powerUP!!! 

# Visualizing interactions within levels of `Test`

These are observed (zero-order)-effect plots. Given the high correlation between age, height, and mass, the figures do not show the effects with statistical adjustment for the correlations. These will be shown in partial-effect plots and they will correspond to the fixed-effect statistics of the LMM. 

## Effect of height

The figure could be deceptive. We need to look at partial effects!

```{r message=FALSE, fig.width=7, fig.height=3.5}
t_HST <- 
  dat %>% 
  mutate(Height = quantcut(height, q=8)) %>% 
  group_by(Test, Sex, Height) %>% 
  summarise(N=n(), M_z=mean(zScore), M_height=mean(height), .groups="drop")

fig3 <- 
  dat %>%
  ggplot(aes(x=height, y=zScore, group=Sex, shape=Sex)) +  
  facet_grid(. ~ Test) +
  geom_smooth(method="lm", formula=y ~ poly(x,1), se=TRUE,  colour="black", size=.75) + 
  geom_point(data=t_HST, aes(x=M_height, y=M_z), fill="white", size=2) + 
  scale_shape_manual(values=c(16, 21, 18, 19)) +
  scale_x_continuous("Height [cm]") +
  scale_y_continuous("z-score") + 
  coord_cartesian(ylim=c(-1,3.5)) + theme_bw() +
  theme(legend.justification=c(.01,.99), legend.position=c(.01, .99),legend.title=element_blank()) 
fig3

ggsave("figures/Fig3_HST.pdf", width=7, height=3.5)
```

+ Very strong effects of height, especially on `PowerUP`; exception `Endurance`.
+ Negative quadratic trend for girls in `Endurance`.  

## Effect of mass

The figure could be deceptive. We need to look at partial effects! 

```{r message=FALSE, fig.width=7, fig.height=3.5}
t_MST <- 
  dat %>% 
  mutate(Mass = quantcut(mass, q=5)) %>% 
  group_by(Test, Sex, Mass) %>% 
  summarise(N=n(), M_z=mean(zScore), M_mass=mean(mass), .groups="drop")

fig4 <- 
  dat %>%
  ggplot(aes(x=mass, y=zScore, group=Sex, shape=Sex)) +  
  facet_grid(. ~ Test) +
  geom_smooth(method="lm", formula=y ~ poly(x,1), se=TRUE,  colour="black", size=.75) + 
  geom_point(data=t_MST, aes(x=M_mass, y=M_z), fill="white", size=2) + 
  scale_shape_manual(values=c(16, 21, 18, 19)) +
  scale_x_continuous("Mass [kg]") +
  scale_y_continuous("z-score") + 
  coord_cartesian(xlim=c(20,60), ylim=c(-1,3.5)) + theme_bw() +
  theme(legend.justification=c(.01,.99), legend.position=c(.01, .99),legend.title=element_blank()) 
fig4

ggsave("figures/Fig4_MST.pdf", width=7, height=3.5)
```

It looks like a positive effect of mass for all but `Endurance`; very strong for `PowerUP`, but the partial effects are negative for all except for `PowerUP`, because then the positive contribution of `height` is removed.

Moreover, we definitely need a quadratic term for `mass` in the LMM: For obese children there is already a negativ effect visible for all tests. 

## Interaction of `height` and `mass`

Here we grouping childrend into equally large ranges of `height` and `mass` values.

```{r message=FALSE, fig.width=7, fig.height=3.5}
t_HMT <- 
  dat %>% 
  mutate(Height = cut(height, breaks=3), 
         Mass = cut(mass, breaks=3)) %>% 
  group_by(Test, Height, Mass) %>% 
  summarise(N=n(), M_height=mean(height), M_mass=mean(mass), M_z=mean(zScore),  .groups="drop") %>% 
  filter(N >= 8 )

fig5 <- 
  t_HMT %>%
  ggplot(aes(x=Height, y=M_z, group=Mass, shape=Mass, color=Mass)) +  
  facet_grid(. ~ Test) +
  geom_line() +  geom_point(fill="white", size=2) + 
  scale_shape_manual("Mass [kg]", values=c(16, 21, 19)) +
  scale_color_manual("Mass [kg]", values=c("black", "black", "red")) + 
  xlab("Height [cm]") +
  scale_y_continuous("z-score") + theme_bw() +
  coord_cartesian(ylim=c(-3,3)) + theme_bw() +
  theme(legend.justification=c(.99,.01), legend.position=c(.99, .01),
        axis.text.x = element_text(size = 6)) 
fig5

ggsave("figures/Fig5_HMcT.pdf", width=7, height=3.5)

# Who and in which year?
dat %>% filter(mass > 70) %>% count(Child, Sex, year) %>% data.frame()
```

Here we grouping childrend into rougly equally large groups of `height` and `mass` values; cells are smaller because of cross classification.

```{r message=FALSE, fig.width=7, fig.height=3.5}
t_HMTqc <- 
  dat %>% 
  mutate(Height = quantcut(height, q=3), 
         Mass = quantcut(mass, q=3)) %>% 
  group_by(Test, Height, Mass) %>% 
  summarise(N=n(), M_height=mean(height), M_mass=mean(mass), M_z=mean(zScore),  .groups="drop") 

fig5b <- 
  t_HMTqc %>%
  ggplot(aes(x=Height, y=M_z, group=Mass, shape=Mass, color=Mass)) +  
  facet_grid(. ~ Test) +
  geom_line() +  geom_point(fill="white", size=2) + 
  scale_shape_manual("Mass [kg]", values=c(16, 21, 19)) +
  scale_color_manual("Mass [kg]", values=c("black", "black", "red")) + 
  xlab("Height [cm]") +
  scale_y_continuous("z-score") + theme_bw() +
  coord_cartesian(ylim=c(-3,3)) + theme_bw() +
  theme(legend.justification=c(.99,.01), legend.position=c(.99, .01),
        axis.text.x = element_text(size = 6)) 
fig5b

ggsave("figures/Fig5_HMqT.pdf", width=7, height=3.5)
```

## Interaction of `height x mass x Sex` for `PowerUP`

Here we grouping childrend into rougly equally large groups of `height` and `mass` values; cells are smaller because of cross classification.

```{r message=FALSE, fig.width=5, fig.height=3.5}
t_HMS_bpt <- 
  dat %>% 
  filter(Test == "PowerUP") %>% 
  mutate(Height = quantcut(height, q=3), 
         Mass = quantcut(mass, q=3)) %>% 
  group_by(Sex, Height, Mass) %>% 
  summarise(N=n(), M_height=mean(height), M_mass=mean(mass), M_z=mean(zScore),  .groups="drop")

fig6 <- 
  t_HMS_bpt %>%
  ggplot(aes(x=Height, y=M_z, group=Mass, shape=Mass, color=Mass)) +  
  facet_grid(. ~ Sex) +
  geom_line() +  geom_point(fill="white", size=2) + 
  scale_shape_manual("Mass [kg]", values=c(16, 21, 19)) +
  scale_color_manual("Mass [kg]", values=c("black", "black", "red")) + 
  xlab("Height [cm]") +
  scale_y_continuous("z-score for PowerUP") + theme_bw() +
  coord_cartesian(ylim=c(-1,3)) + theme_bw() +
  theme(legend.justification=c(.70,.99), legend.position=c(.70, .99)) 
fig6

ggsave("figures/Fig6_HMqS_bpt.pdf", width=5, height=3.5)
```

# Appendix 
 
```{r include=TRUE}
sessionInfo()
```
