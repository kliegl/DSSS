---
title: "Credit Risk: Preprocessing"
author: "Bella Mamedova"
date: "2022-02-28 (updated: `r Sys.Date()`)"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: no
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Background

First of all, I define my "research question" in order to understand what I want to achieve from this data and what variables will be (in)dependent. I took this data from Kaggle, where it was used to predict the credit risks, however, I myself will try to use them for other, simpler purposes. For instance, I want to see the distribution of loan amounts (the amount of money that is usually borrowed). Age is an independent numerical variable. As for the Duration of the credit and its amount, these are dependent variables, so we can see whether they have any connection with the citizens' age.

# ReadMe

+ "Job" is numeric 
    + 0: unskilled and non-resident
    + 1: unskilled and resident
    + 2: skilled
    + 3: highly skilled

```{r}
library(tidyverse)
library(readxl)   
library(lubridate)


library(summarytools) # dfSummary(), descr(), freq()
```

# Reading data and preprocessing

Of course, you can also combine reading preprocessing of data (i.e., selecting the variables, filtering the observations, etc.) in a single chunk.

I am introducing an additional "style guide for naming variables. 

+  Factors are capitalized
+  Covariates are in all lower case

In this case, most factors are also ordered. Depending on the context, these variables we may want to use as factors or as covariates (possibly centered). Although a bit redundant, we keep our options open here. In a final version of the analysis, we may want to get rid of the versions that are not used. 

```{r}
data <- read_xlsx("data/Mamedova_1_GermanCredit.xlsx") 
#view(dfSummary(data))

dat <- 
  data |> 
  rename(age=2, job=Job, Saving=6, Checking=7, credit=8, duration=9) |> 
  mutate(Subj = paste0("S", str_pad(Subj, width=3, side="left", pad="0")),
         Sex = factor(Sex, levels=c("female", "male")),
         Job = ordered(job, labels=c("unskilled, not resident", "unskilled, resident", 
                                    "skilled", "highly skilled")),
         Housing =  ordered(Housing, levels=c("free", "rent", "own")),
         Saving  =  ordered(Saving,  levels=c("little", "moderate", "quite rich", "rich")),
         Checking = ordered(Checking, levels=c("little", "moderate", "rich")),
         Purpose  = factor(Purpose),
         job = job - 1.5,
         housing =  as.numeric(Housing) - 2,
         saving =   as.numeric(Saving)  - 2.5,
         checking = as.numeric(Saving)  - 2.5
         ) |> 
  select(Subj, Sex, Job, Housing:Checking, Purpose, job, housing:checking, duration, credit)
  
# check
#view(dfSummary(dat))
```

# Summary statistics

## Factor variables

```{r}
dat |> select(Sex:Purpose) |> freq()
```


## Numerical variables

```{r}
descr(dat, stats="common")  
```

# Visualization

## Duration

```{r}
dat |>
  group_by(Sex, Job) |> 
  summarise(N=n(), dur_M=mean(duration, na.rm=TRUE), dur_SE=sd(duration, na.rm=TRUE)/sqrt(N)) |> 
  ggplot(aes(x=Job, y=dur_M, group=Sex, color=Sex)) +
  geom_point(position=position_dodge(width=.1)) + geom_line(position=position_dodge(width=.1)) +
  geom_errorbar(aes(ymax=dur_M + 2*dur_SE, ymin=dur_M - 2*dur_SE), width=0.15,
                position=position_dodge(width=.1)) +
  scale_colour_manual("", values=c("red", "blue")) +
  scale_y_continuous("Duration [months]") +
  theme_bw()
```


## Amount of credit

```{r}
dat |>
  group_by(Sex, Job) |> 
  summarise(N=n(), crdt_M=mean(credit, na.rm=TRUE), crdt_SE=sd(credit, na.rm=TRUE)/sqrt(N)) |> 
  ggplot(aes(x=Job, y=crdt_M, group=Sex, color=Sex)) +
  geom_point(position=position_dodge(width=.1)) + geom_line(position=position_dodge(width=.1)) +
  geom_errorbar(aes(ymax=crdt_M + 2*crdt_SE, ymin=crdt_M - 2*crdt_SE), width=0.15,
                position=position_dodge(width=.1)) +
  scale_colour_manual("", values=c("red", "blue")) +
  scale_y_log10("Credit [EUR]") +
  theme_bw()
```

# Appendix

This command ensures that somebody at some later time can reproduce your analysis.

```{r}
sessionInfo()
```
