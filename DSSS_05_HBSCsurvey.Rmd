---
title: "Analyses of HBSC network survey: Preprocessing"
author: "Dolzhin Toktonova"
date: "2022-02-21 (updated: `r Sys.Date()`)"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: no
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

# Background

Health behaviour in school-aged children [HSBC](http://www.hbsc.org/about/) 

"The HBSC research network is an international alliance of researchers that collaborate on the cross-national survey of school students: Health Behaviour in School-aged Children (HBSC). The HBSC collects data every four years on 11-, 13- and 15-year-old boys' and girls' health and well-being, social environments and health behaviours. These years mark a period of increased autonomy that can influence how their health and health-related behaviours develop."

1. I will use data collected by HBSC research network.
2. The format of the data is spss file. Variables contain information both as numberic and labelled using the [haven package](https://haven.tidyverse.org/articles/semantics.html)

# Setup

```{r}
library(tidyverse)
library(haven)   # this package allows us to read spss files

library(summarytools) # dfSummary(), descr(), freq()
```

# Reading the data

```{r}
path <- file.path("students/data/Toktonova_1_HBSCsubset.sav")  
data <- read_sav(path)
```

Letâ€™s look through summary statistics of the file

```{r}
view(dfSummary(data))
```

Here we can see the somewhat unusual coding of the data as "dbl+lbl", that is double (numeric) and labelled. 

It looks like `id4` codes the child number within countries.

It looks like country and region are the same for these five countries.

# Preprocessing

We look at a few variables.

```{r}
dat_w <- 
  data |> 
  as_tibble() |> 
  filter(!is.na(AGECAT)) |> 
  select(COUNTRYno, id4, sex, grade, AGECAT, hourexce) |> 
  mutate(Country = as_factor(COUNTRYno),
         Child = paste0(str_sub(Country,1,2), str_pad(id4, width=4, side="left", pad="0")),
         Child = as_factor(Child),
         Sex = as_factor(sex),
         Age = as_factor(AGECAT),
         across(physact60:welloff, as.numeric)) |> 
  select(Country:Age, welloff, physact60:acachieve) |> 
  droplevels()
```

# Multiple regression



```{r}


```





```{r}
# 
dat <- 
  dat_w |> 
  pivot_longer(physact60:acachieve, names_to="Measure", values_to="rating") |> 
  mutate(Measure=factor(Measure, levels=c("hourexce", "timeexe", "physact60",
                                          "acachieve", "lifesat")))
```


# Descriptives

## Third-order interaction

### Table of means
```{r}
tbl4 <- 
  dat |>
  group_by(Measure, Country, Sex, Age) |> 
  summarise(N=n(), score_M=mean(rating, na.rm=TRUE), score_SD=sd(rating, na.rm=TRUE))
```

### Graph

```{r}
tbl4 |>  
  ggplot(aes(x=Age, y=score_M, group=Country, color=Country)) +
  facet_grid(Sex ~ Measure) +
  geom_point() + geom_line() +
  theme_bw()
```

## First-order interaction

### Table of means
```{r}
tbl2 <- 
  dat |>
  group_by(Measure, Country) |> 
  summarise(N=n(), score_M=mean(rating, na.rm=TRUE), score_SD=sd(rating, na.rm=TRUE))
```

### Graph

```{r}
tbl2 |>  
  ggplot(aes(x=Measure, y=score_M, group=Country, color=Country)) +
  geom_point() + geom_line() +
  theme_bw()
```


## First-order interaction for academic achievement

### Table of means
```{r}
tbl2aca <- 
  dat |>
  filter(Measure == "acachieve") |> 
  group_by(Country, Age) |> 
  summarise(N=n(), score_M=mean(rating, na.rm=TRUE), score_SD=sd(rating, na.rm=TRUE)) |> 
  rename("Academic Achievement" = score_M)
```

### Graph

```{r}
tbl2aca |>  
  ggplot(aes(y=`Academic Achievement`, x=Country, group=Age, color=Age)) +
  geom_point() + geom_line() +
  theme_bw()
```

# Appendix

This command ensures that somebody at some later time can reproduce your analysis.

```{r}
sessionInfo()
```
