---
title: "EMOTIKON: Preprocessing of Longitudinal Study"
author: "Reinhold Kliegl, Thea Fühner, & Kathleen Golle"
date: "2021-02-16 (updated: `r Sys.time()`)"
output:
  html_document:
    number_sections: yes
    toc: yes
    toc_depth: 2
    toc_float: no
    code_folding: hide
editor_options: 
  chunk_output_type: console
---

# Background

Data are from Golle et al. (2015). Physical Fitness Percentiles of German Children Aged 9–12 Years: Findings from a Longitudinal Study. _PLoS ONE, 10,_ 11 (doi:10.1371/journal.pone.0142393).

`boxcox()` suggests speed transformation of S20 and Star. Taking the distance run in each test into account, the transformations converts both measures to `m/s`.

We z-transform scores with mean and standard deviation of first assessment in 2006.

```{r}
library(tidyverse)
library(haven)
library(readxl)
library(cowplot)

```

# Long format

+ I am not the only one having problems reading **some** spss files; see:
    + https://github.com/tidyverse/haven/issues/615
    + https://github.com/WizardMac/ReadStat/pull/252 
+ There is a workaround for us. I was able to open the file with SPSS and save it as .xlsx spreadsheet and as .csv.

```{r}
#dat <- read_spss("data/gmwg15.sav") %>%     # spss does not work currently
#dat <- read_csv("data/gmwg15.csv") |>       # comma separated values works

dat <- read_xlsx("data/gmwg15.xlsx") |>      # excel works
  select(School=School_number, Child=number, Sex=sex,
        age_t1:age_t4, height_06:height_09,
        weight_06:weight_09, bmi_06:bmi_09,
        fat_06:fat_09,
        sprint_06:enduranceRun_09) %>% 
  pivot_longer(cols=27:50, names_to=c("Test", "year"), names_sep="_", values_to="score") %>% 
  mutate(School = as_factor(paste0("S", School)),
         Child = as_factor(paste0("C", str_pad(Child, 3, "left", "0"))),
         Sex = as_factor(Sex),
         Sex= fct_recode(Sex, Boys = "1", Girls = "2"),
         Sex = fct_relevel(Sex, "Boys", "Girls"),
         year = as.numeric(year)+2000,
         age = if_else(year==2006, age_t1, 
               if_else(year==2007, age_t2,
               if_else(year==2008, age_t3, age_t4))),
         height = if_else(year==2006, height_06, 
                  if_else(year==2007, height_07,
                  if_else(year==2008, height_08, height_09))),
         mass = if_else(year==2006, weight_06, 
                if_else(year==2007, weight_07,
                if_else(year==2008, weight_08, weight_09))),
         bmi = if_else(year==2006, bmi_06, 
               if_else(year==2007, bmi_07,
               if_else(year==2008, bmi_08, bmi_09))),
         fat = if_else(year==2006, fat_06, 
               if_else(year==2007, fat_07,
               if_else(year==2008, fat_08, fat_09))),
         Test = fct_recode(Test, Endurance = "enduranceRun", Coordination="starRun", Speed = "sprint", 
                           'PowerLOW' = "tripleHopp", 'PowerUP' = "ballp", 
                           Flexibility = "standReach"),
         Test = fct_relevel(Test, "Endurance", "Coordination", "Speed", "PowerLOW"),
         score = if_else(Test == "Speed", 50/score,
                 if_else(Test == "Coordination", 50.912/score, score))) %>% 
         select(School, Child, Sex, year, age, height, mass, bmi, fat, Test, score)

z_norms <-
  dat %>% 
  filter(year == 2006) %>% 
  group_by(Test) %>% 
  summarise(M=mean(score), SD=sd(score), .groups="drop")

dat <- left_join(dat, z_norms, by="Test") %>% mutate(zScore = (score - M)/SD) 


saveRDS(dat, file="data/gmwg15.rds")  

# to read a file saved with saveRDS use:
dat <- readRDS("data/gmwg15.rds")
```


# Wide format

```{r}
dat_anthr_w <- 
  dat %>% 
  group_by(Child, School, year) %>% 
  summarise(age = first(age), height = first(height), mass=first(mass), 
            fat=first(fat), bmi=first(bmi), .groups="drop") %>% 
  pivot_wider(names_from = year, values_from=c(age, height, mass, fat, bmi))

dat_test_w <- 
  dat %>% 
  select(Child, School, year, Test, score) %>% 
  pivot_wider(names_from = c(Test, year), values_from=c(score))

dat_w <- left_join(dat_anthr_w, dat_test_w, by=c("Child", "School"))

saveRDS(dat, file="data/gmwg15_wide.rds")
```

# Appendix 
 
```{r include=TRUE}
sessionInfo()
```

